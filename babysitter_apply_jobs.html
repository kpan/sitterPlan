<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<!-- Load style sheets -->
<link href='http://fonts.googleapis.com/css?family=Bubblegum+Sans|Noto+Sans' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" />
<link rel="stylesheet" type="text/css" href="sitterPlan.css" />

<!-- Load any supplemental Javascript libraries here -->
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" />
<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
<script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
<script type="text/javascript" src="schedule_table.js"></script>

<title>SitterPlan</title>
</head>
<script>
	//the times on the schedule to display (controlled by the slider)
	var earliestTimeOnSchedule = 13;
	var latestTimeOnSchedule = 24;
	//color to paint in, currently always green
	var currentColor = "green";
	//whether the mouse button is down
	var painting = false;
	//the first date to display (currently always today)
	var earliestDateOnSchedule = new Date();

	//representation of which things are colored
	var babysitterScheduleTable = new ScheduleTable(24, 7);
	
	//update the displayed table with new information if stuff gets painted
	babysitterScheduleTable.addEventListener('paint',function (e) {
		if (e.details.newColor == "green") {
			$( "#" + e.details.day + "_" + e.details.hour + "_square").attr('class', 'greenScheduleTableSquare');
		} else if (e.details.newColor == "blank") {
			$( "#" + e.details.day + "_" + e.details.hour + "_square").attr('class', 'blankScheduleTableSquare');
		}
    },true);
	
	//initialization things
	$(function() {
		// add all the rows for the various hours of days to the table you can paint
		for (var i = earliestTimeOnSchedule; i < latestTimeOnSchedule; i ++){
			$("#babysitterScheduleTable > tbody > tr:last").after(genRow(i));
		}
		
		// make the labels for the columns
		for (var i = 0; i < 7; i++) {
			var tempDate = new Date();
			tempDate.setDate(earliestDateOnSchedule.getDate() + i);
			var dateString = tempDate.toDateString();
			dateString = dateString.substring(0, dateString.length - 4);
			$("#day" + i).text(dateString);
		}
		
		// initialize the slider for which times are showing
		makeSlider();
  	});
	
	//initialize the slider for which times are showing.
	function makeSlider() {
		$( "#timerange-slider" ).slider({range: true, min: 0, max:24,
									 orientation:"vertical",
									 values:[ 24 - latestTimeOnSchedule,
									 		  24 - earliestTimeOnSchedule ],
									 slide: function( event, ui ) {
										 		updateTimerange( 24 - ui.values[1],
												           24 - ui.values[0]);
									 }}).height("300px");
		$( "#timerange-slider > a:first").text(asShort12HourTime(latestTimeOnSchedule)).addClass("sliderLabel");
		$( "#timerange-slider > a:last").text(asShort12HourTime(earliestTimeOnSchedule)).addClass("sliderLabel");
	}
	
	// track whether the mouse button is down
	document.onmousedown = function() {
		painting = true;
	}
	
	document.onmouseup = function() {
		painting = false;
	}
	
	// on mouseover to a table cell, paint it if the mouse button's down
	function paintIfClicking(event, day, time) {
		if (painting) {
			babysitterScheduleTable.paint(day, time, currentColor);
		}
	}

	// make a row for the table: makes a bunch of table cells with appropriate event handlers
	function genRow(time) {
		var row = "<tr class='scheduleTableRow' id='" + as12HourTime(time) + "row" + 
				  "'>\n<td class='scheduleRowLabel'>";
		row += as12HourTime(time) + "</td>\n";
		for (var day = 0; day < babysitterScheduleTable.width; day ++) {
			row += "<td class='";
			row += babysitterScheduleTable.getColor(day,time) + "ScheduleTableSquare";
			row += "' id='" + day + "_" + time + "_square' ";
			row += "onmousedown='babysitterScheduleTable.paint(" + day + "," + time + ", currentColor)' ";
			row += "onmouseover='paintIfClicking(event," + day + "," + time + ")'/>\n";
		}
		row += "</tr>\n"
		return row;
	}
	
	// scale the table appropriately when the slider moves	
	function updateTimerange(startTime, endTime){
		$( "#startTime").text(as12HourTime(startTime));
		$( "#endTime").text(as12HourTime(endTime));
		
		$( "#timerange-slider > a:first").text(asShort12HourTime(endTime));
		$( "#timerange-slider > a:last").text(asShort12HourTime(startTime));
		
		for (var i = earliestTimeOnSchedule; i < startTime; i++) {
			$("#" + as12HourTime(i) + "row").remove();
		}
		
		for (var i = startTime; i < endTime; i ++){
			if (i < earliestTimeOnSchedule || i >= latestTimeOnSchedule) {
				$("#babysitterScheduleTable > tbody > tr").eq(i - startTime).after(genRow(i));
			}
		}
		for (var i = endTime; i < latestTimeOnSchedule; i++) {
			$("#" + as12HourTime(i) + "row").remove();
		}
		earliestTimeOnSchedule = startTime;
		latestTimeOnSchedule = endTime;
	}
	
	// convert a number to a nice time like "5am"
	function as12HourTime(number) {
		if (number == 0 || number == 24) {
			return "midnight";
		}
		if (number < 12) {
			return number + "am";
		}
		if (number == 12) {
			return "noon";
		} else {
			return (number - 12) + "pm";
		}
	}	

	// convert a number to a short time like "5"
	function asShort12HourTime(number) {
		if (number == 0) {
			return 12;
		}
		if (number <= 12) {
			return number;
		}
		return number - 12;
	}	
	
	// close the dialog, clear all its data, make a new row in the jobs list
	function submitSchedule() {
		$.post("schedule/jimmy/", {times:babysitterScheduleTable.getPostableTimeblocks(earliestDateOnSchedule)}, 
			   function(data){alert(data);});
		$("#hidingDiv").append($("#editSchedulePopup").remove());
		$("#editSchedulePopup").dialog('close');
	}
	
	// get the times that are painted over, as a string
	function getFreeTimes() {
		var time = "";
		var outputstrings = [];
		var timeblocks = babysitterScheduleTable.getTimeblocks();
		for (var i = 0; i < timeblocks.length; i++) {
			var block = timeblocks[i];
			outputstrings.push($("#day" + block.start.day).text() + " " + as12HourTime(block.start.hour) 
									 + " to " + as12HourTime(block.end.hour));
		}
		return time + outputstrings.join(" or ");
	}

	// show the job creation popup
	function showEditSchedule(){
		$("#hidingDiv").append($("#editSchedulePageOne").detach());
		$("#hidingDiv").append($("#editSchedulePageTwo").detach());
      	dialog = $("#editSchedulePopup").dialog({title:"Edit Your Schedule",
									 modal:true, 
									 draggable:false,
									 width:800, 
									 height:600}).addClass("bodyFont").append($("#editSchedulePageOne"));
		makeSlider();
  	}
	
	// show the contacts managing popup
	function showManageContacts(){
      	$("#manageContactsPopup").dialog({title:"Manage Contacts",
									 modal:true, 
									 draggable:false, 
									 width:800, 
									 height:600}).addClass("bodyFont");
  	}
	
	function showApplyJobPopup(){
      	$("#applyJobPopup").dialog()	}
	
</script>

<script>
    //update calendar labels based on date
    var months = new Array("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December");
    var month = 4; //starts at 0
    var year = 2013;
    var day = 5; //date of the Sunday of the week being displayed

    function isLeapYear(year){
       if (year % 4 != 0) { return false; }
       if (year % 100 != 0) { return true; }
       if (year % 400 == 0) { return true; }
       else{ return false; }
    }

    function daysInMonth(month){
        var daysInMonth = new Array(31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31, 30, 31);
        if (month == 1 && isLeapYear(year)){
            return 29;
        }
        else {
            return daysInMonth[month];
        }
    }

    function dateToDisplay(offset){
        //figures out date offset number of days after Sunday
        today = day + offset;
        if (today > daysInMonth(month)){
            return today - daysInMonth(month);
        }
        else{
            return today
        }
    }

    function updateLabels(){
        $("#sundayLabel").text('Sun ' + day);
        $("#mondayLabel").text('Mon ' + dateToDisplay(1));
        $("#tuesdayLabel").text('Tue ' + dateToDisplay(2));
        $("#wednesdayLabel").text('Wed ' + dateToDisplay(3));
        $("#thursdayLabel").text('Thurs ' + dateToDisplay(4));
        $("#fridayLabel").text('Fri ' + dateToDisplay(5));
        $("#saturdayLabel").text('Sat ' + dateToDisplay(6));

        $("#monthLabel").text(months[month] + ' ' + year);
    };

    $(function () {updateLabels()});

    function goToNextWeek(){
        day = day + 7;
        if (day >  daysInMonth(month)){
            day = day - daysInMonth(month);
            month = month + 1;
            if (month > 11){
                month = 0;
                year = year + 1;
            }
        }
        updateLabels();
    };


    function goToPrevWeek(){
        day = day - 7;
        if (day <  1){
            month = month - 1;
            if (month < 0){
                month = 11;
                year = year - 1;
            }
            day = day + daysInMonth(month);           
        }       
        updateLabels();
    };


</script>


<body>
<div id="logo">SitterPlan</div>
<table id="buttonRow">
	<tr>
    	<td></td>
        <td>
            <a href="list" style="text-decoration:none"> <input id="myJobs" type="button" name="myJobs" class="bigButton" value="Back to My Jobs"/> </a>
        </td>
    	<td>
			<input id="editSchedule" type="button" name="editSchedule" value="Edit Schedule" class="bigButton" onclick="showEditSchedule();" />
        </td>
        <td>
            <input id="manageContactsButton" type="button" name="manageContacts" value="Manage Contacts" onclick="showManageContacts();" class="bigButton"/>
        </td>
    </tr>
</table>

<div id="mainDiv">
<h2>My Schedule</h2>

</style>
</head>
<body>
<div id="monthLabel" class="title" align='center'>April 2013</div>
<table style="width:90%; border:none">
	<tr>
    	<th style="width:10%;"></th>
    	<th id="sundayLabel" style="width:13%;">Sun</th>
        <th id="mondayLabel" style="width:13%;">Mon</th>
        <th id="tuesdayLabel" style="width:13%;">Tue</th>
        <th id="wednesdayLabel" style="width:13%;">Wed</th>
        <th id="thursdayLabel" style="width:13%;">Thu</th>
        <th id="fridayLabel" style="width:13%;">Fri</th>
        <th id="saturdayLabel" style="width:13%;">Sat</th>
    </tr>
	<tr>
    	<td align='right'>6:00pm</td>
        <td class="freeSquare"></td>
        <td class="freeSquare"></td>
        <td class="freeSquare"></td>
        <td class="freeSquare"></td>
        <td class="freeSquare"></td>
        <td class="nonfreeSquare"><div class="availableTop">Evans</div></td>
        <td class="freeSquare"></td>
    </tr>
	<tr>
    	<td align='right'>7:00pm</td>
        <td class="freeSquare"></td>
        <td class="freeSquare"><div class="availableTop">Smith</div></td>
        <td class="freeSquare"><div class="acceptedTop">Frank</div></td>
        <td class="freeSquare"></td>
        <td class="freeSquare"><div class="acceptedTop">Wu</div></td>
        <td class="nonfreeSquare"><div class="availableMiddle">Evans</div></td>
        <td class="freeSquare"><div class="acceptedTop">Goldstein</div></td>
    </tr>
	<tr>
    	<td align='right'>8:00pm</td>
        <td class="freeSquare"></td>
        <td class="freeSquare"><div class="availableMiddle">Smith</div></td>
        <td class="freeSquare"><div class="acceptedBottom">Frank</div></td>
        <td class="freeSquare"><div class="availableTop">Anderson</div></td>
        <td class="freeSquare"><div class="acceptedMiddle">Wu</div></td>
        <td class="nonfreeSquare"><div class="availableMiddle">Evans</div></td>
        <td class="freeSquare"><div class="acceptedMiddle">Goldstein</div></td>
    </tr>
	<tr>
    	<td align='right'>9:00pm</td>
        <td class="freeSquare"></td>
        <td class="freeSquare"><div class="availableBottom">Smith</div></td>
        <td class="freeSquare"></td>
        <td class="freeSquare"><div class="availableBottom">Anderson</div></td>
        <td class="freeSquare"><div class="acceptedMiddle">Wu</div></td>
        <td class="nonfreeSquare"><div class="availableBottom">Evans</div></td>
        <td class="freeSquare"><div class="acceptedMiddle">Goldstein</div></td>
    </tr>
	<tr>
    	<td align='right'>10:00pm</td>
        <td class="freeSquare"></td>
        <td class="freeSquare"></td>
        <td class="freeSquare"></td>
        <td class="freeSquare"></td>
        <td class="freeSquare"><div class="acceptedMiddle">Wu</div></td>
        <td class="nonfreeSquare"></td>
        <td class="freeSquare"><div class="acceptedMiddle">Goldstein</div></td>
    </tr>
	<tr>
    	<td align='right'>11:00pm</td>
        <td class="freeSquare"></td>
        <td class="freeSquare"></td>
        <td class="freeSquare"></td>
        <td class="freeSquare"></td>
        <td class="freeSquare"><div class="acceptedMiddle">Wu</div></td>
        <td class="nonfreeSquare"></td>
        <td class="freeSquare"><div class="acceptedBottom">Goldstein</div></td>
    </tr>
	<tr>
    	<td align='right'>11:00pm</td>
        <td class="freeSquare"></td>
        <td class="freeSquare"></td>
        <td class="freeSquare"></td>
        <td class="freeSquare"></td>
        <td class="freeSquare"><div class="acceptedBottom">Wu</div></td>
        <td class="nonfreeSquare"></td>
        <td class="freeSquare"></td>
    </tr>
</table>
</div>
<div>
	<p>&nbsp </p>
	<table  style="width:90%; border:none">
		<tr>
			<td  style="width:10%;"></td>
			<td  style="width:10%;"><b> Legend </b></td>
		</tr>
		<tr>
			<td  style="width:10%;"></td>
			<td class="freeSquare"  style="width:10%;"> Available </td>
			<td class="nonfreeSquare"  style="width:10%;"> Busy </td>
			<td class="freeSquare"  style="width:10%;"> <div class="acceptedSingleSquare"> Accepted Job</div></td>
			<td class="freeSquare"  style="width:10%;"> <div class="availableSingleSquare">Available Job</div></td>
            <td style="width:fill"/>
            <td style="width:10%;"> <input id="prevWeek" type="button" name="prevWeek" value="previous week" onclick="goToPrevWeek()"/> </td>
            <td style="width:10%;"> <input id="nextWeek" type="button" name="nextWeek" value="next week" onclick="goToNextWeek()"/> </td>
		</tr>
	</table>
</div>

<div id="manageContactsPopup" style="display:none;">
		<span>Search for new contacts<span>
		<input type="text" name="Search" value="username">
		<input id="searchContactParents" type="button" value="Search"/>
		<div id="contacts">
			<h2>My Contacts</h2>
			<div id="contactList">
				<a href="javascript:none;">Anderson</a><br>
				<a href="javascript:none;">Evans</a><br>
				<a href="javascript:none;">Frank</a><br>
				<a href="javascript:none;">Goldstein</a><br>
				<a href="javascript:none;">Smith</a><br>
				<a href="javascript:none;">Wu</a><br>
			</div>
		</div>
</div>
<div id="hidingDiv" style="display:none;">
    <div id="editSchedulePopup" style="-webkit-user-select:none;-moz-user-select:none;"></div>
	<div id="editSchedulePageOne" style="-webkit-user-select:none;-moz-user-select:none;">
		<p>Pick times you are free by painting the calendar.</p>
		<table>
        	<tr>
            	<td valign="top"><div id="timerange-slider"></div></td>
                <td>
					<table id="babysitterScheduleTable" class="scheduleTable" />
    					<tbody>
							<tr class='scheduleTableRow'>
								<td class="scheduleTableLabel" ></td>
								<td id="day0" class="scheduleTableLabel">Sunday</td>
								<td id="day1" class="scheduleTableLabel">Monday</td>
								<td id="day2" class="scheduleTableLabel">Tuesday</td>
								<td id="day3" class="scheduleTableLabel">Wednesday</td>
								<td id="day4" class="scheduleTableLabel">Thursday</td>
								<td id="day5" class="scheduleTableLabel">Friday</td>
								<td id="day6" class="scheduleTableLabel">Saturday</td>
							</tr>
    					</tbody>
					</table>
        		</td>
        	</tr>
        </table>
		<br/>
        <table><tr>
        <td><input align="top" type="button" name="done" value="Done" onclick="submitSchedule()"/></td></tr></table>
	</div>
	<div id="applyJobPopup" title="">
		<p>Do you want to apply to the job?</p>
		<!-- need to retrieve job name here-->
		<table>
			<td>
				<tr> <input align="top" type="button" name="ok" value="OK" onclick="$('#applyJobPopup').dialog('close')"/> </tr>
				<tr><input align="top" type="button" name="cancel" value="Cancel" onclick="$('#applyJobPopup').dialog('close')"/> </tr>
			</td>
		</table>
	</div>
</div>
</div>
</body>
</html>
